% !TeX spellcheck = ru_RU
% !TEX root = vkr.tex

% \section{Постановка задачи}
% \label{sec:task}
\section{Введение}
Бинарные трансляторы являются инструментами для эмуляции, бинарного анализа и профиляции, важным классом которых являются динамические бинарные трансляторы, которые преобразуют двоичный ход на лету и генерируют нужные инструкции по мере требования. Примером такого транслятора является Rosetta 2. Часто, исходный двоичный код преобразуется в какое-либо промежуточное представление, где такое преобразование осуществляет лифтер. Примерами такого представления являются TCG для QEMU. Но в качестве промежуточного представления хочется использовать LLVM IR, так как тулчейн LLVM может делать качественные оптимизации кода. В данной работе хотим рассмотреть динамические бинарные трансляторы с поднятием двоичного кода в LLVM IR для RISC-V.
\section{Обзор}
Для начала необходимо рассмотреть такие канонические ДБТ, как
\begin{itemize}
    \item QEMU-user, который является стандартом эмуляции userland программ;
    \item Rosetta 2, который является эмулятором с закрытым исходным кодом от Apple;
    \item Valgrind, который является инструментом динамического бинарного анализа в состав которого входит Memcheck и Callgrind.
\end{itemize}

Также довольно популярным является Box64, который позволяет запускать программы, в частности игры, скомпилированные под linux x86/x64, на ARM64 и RISC-V, и который отличается производительностью.
Из ДБТ с поднятием в LLVM IR, можно выделить
\begin{itemize}
    \item BinRec (не обновлялся с 2022го года);
    \item HQEMU (не обновлялся с 2018го года);
    \item DBILL, LnQ, Lasagne (есть только статьи, либо код закрыт).
\end{itemize}

В результате обзора стало понятно, что, судя по бенчмаркам, Instrew + Rellume производительнее, чем QEMU и Valgrind, благодаря оптимизациям LLVM. Также, в сравнение: с QEMU, Valgrind и Box64, является не только эмулятором, но и инструментом для динамического бинарного анализа (что позволяет менять семантику транслируемых программ), так как из коробки имеет API для добавления анализаторов, например, подсчет инструкций.
Также в сравнение с другими ДБТ с поднятием в LLVM IR поддерживается контрибьютором и не заброшен, а также имеет поддержку архитектуры RISC-V, как целевой.

\section{Постановка задачи}
Целью работы является добавление поддержки host-архитектуры RISC-V. Для ее выполнения были поставлены следующие задачи:
\begin{itemize}
    \item выполнить обзор архитектуры Instrew;
    \item реализовать минимальную функциональность для запуска Instrew на RISC-V, а именно:
          \begin{itemize}
              \item скомпилировать, добавив процессорно-специфические патчи и проставив константы (макросы riscv, размеры функций, адреса и номера и аргументы системных вызовов);
              \item реализовать функции, связанные с RISC-V ABI (эмуляция системных вызовов, трамплины PLT таблицы, релокации).
          \end{itemize}
    \item протестировать на простых примерах.
\end{itemize}

\section{Архитектура Instrew}
Instrew реализует архитектуру клиент-сервер. Клиент написан на языке Си и из его основных функций можно выделить:
\begin{itemize}
    \item отправка функций транслируемой программы серверу;
    \item получение от сервера ELF объекта, проведение релокаций и разрешение символов.
\end{itemize}
Также важно отметить, что для клиента написана своя реализация libc.

Сервер написан на C++ с помощью LLVM, и его основными функциями являются:
\begin{itemize}
    \item поднятие двоичного кода в LLVM IR с помощью Rellume;
    \item применение оптимизаций и кодогенерация.
\end{itemize}

В данной практике была проведена работа именно над клиентской частью Instrew.


% Дословно \enquote{Целью работы является... Для её выполнения были постав\-лены следующие задачи:}
% \begin{enumerate}
%     \item реализовать это (раздел~\ref{subsec:task1});
%     \item спроектировать то-то (раздел~\ref{subsec:task2}) наилучшим образом;
%     \item протестировать на том-то (раздел~\ref{subsec:task3}) и обогнать тех-то;
%     \item \sout{изучить язык \OCaml{}} писать тут не надо, так как тут должны быть задачи, выполнение которых можно проверить/оценить прочитав текст или выслушав доклад;
%           (т.е. Ваши достижения должны быть опровержимы)
%           \begin{itemize}
%               \item это может вызвать сомнения по поводу обзора~--- \emph{выполнить обзор} писать можно и нужно, но защищаемым результатом будут не ваши знания, а текст обзора (то есть он должен иметь ценность сам по себе);
%           \end{itemize}
%     \item обязательна задача на валидацию результата, будь то эксперимент, апробация, внедрение~--- то есть доказательство того, что Вы сделали что-то, нужное пользователю.
%           Не путайте с валидацией~--- доказательством того, что Вы сделали то, что хотели Вы (например, тесты~--- валидация результата, хорошо, но недостаточно).
% \end{enumerate}
